<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:Zaczy.SongBook.MAUI.ViewModels"
    xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
    xmlns:models="clr-namespace:Zaczy.SongBook;assembly=Zaczy.SongBook"
    xmlns:data="clr-namespace:Zaczy.SongBook.Data;assembly=Zaczy.SongBook"
    x:DataType="vm:SongListViewModel"            
    x:Class="Zaczy.SongBook.MAUI.Pages.SongsPage"
    Title="Piosenki">

    <ContentPage.ToolbarItems>
        <!-- Menu / Toolbar item that triggers import from API -->
        <!--ToolbarItem Text="Import" Command="{Binding FetchCommand}" Order="Primary" Priority="0" /-->
        <ToolbarItem Text="Katalogi piosenek" Command="{Binding CategoriesCommand}" Order="Primary" Priority="0" />
        <ToolbarItem Command="{Binding CategoriesCommand}" Order="Primary" Priority="0" IconImageSource="collect_ico.png" />
    </ContentPage.ToolbarItems>

    <ContentPage.Content>
        <Grid RowDefinitions="Auto,Auto,*,Auto">
            <!-- Filters -->
            <StackLayout 
                Orientation="Horizontal" 
                Spacing="8" 
                Grid.Row="0"
                Background="{AppThemeBinding Light=#D6C6C0, Dark=#100707}"
                Padding="12"
                >
                <Entry Placeholder="Tytuł lub wykonawca"
                       HorizontalOptions="FillAndExpand"
                       Text="{Binding TitleFilter}"
                       PlaceholderColor="{AppThemeBinding Light=#FFF, Dark=#FFF}"
                       Completed="OnTitleFilterCompleted" />
                <ImageButton 
                    Source="{mi:Fluent Search20, IconSize=20, IconColor={AppThemeBinding Light=#761610, Dark=#b66650}}"
                    Command="{Binding FilterCommand}"
                    HorizontalOptions="End"
                    MinimumHeightRequest="32"
                    MinimumWidthRequest="32"
                    BackgroundColor="Transparent"
                    />
                <ImageButton 
                    Source="{mi:Fluent FilterDismiss20, IconSize=20, IconColor={AppThemeBinding Light=#761610, Dark=#b66650}}"
                    Command="{Binding ClearCommand}"
                    HorizontalOptions="End"
                    MinimumHeightRequest="32"
                    MinimumWidthRequest="32"
                    BackgroundColor="Transparent"
                    />
                <ImageButton 
                    Source="{mi:Fluent ArrowClockwise20, IconSize=20, IconColor=#999}"
                    Command="{Binding LoadCommand}"
                    HorizontalOptions="End"
                    MinimumHeightRequest="28"
                    MinimumWidthRequest="28"
                    BackgroundColor="Transparent"
                    />
            </StackLayout>
            
            <!-- List -->
            <CollectionView ItemsSource="{Binding Songs}" SelectionMode="Single" Grid.Row="2" x:Name="SongsCollection" Margin="12,20,12,10">
                <CollectionView.ItemTemplate>
                    <!-- Use the actual item type stored in SongListViewModel.Songs -->
                    <DataTemplate x:DataType="data:SongEntity">
                        <!-- Replace Border with a Grid that draws only top and bottom lines -->
                        <Grid Margin="0,0" Padding="0">
                          <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />  <!-- content -->
                          </Grid.RowDefinitions>

                          <!-- content -->
                            <StackLayout Grid.Row="0" Padding="15,10,10,10" BackgroundColor="{Binding CategoryColor}" Margin="0,0,0,10">
                            <Label Text="{Binding Title}" FontAttributes="Bold" LineBreakMode="TailTruncation" />
                            <Label Text="{Binding Artist}" FontSize="Small" TextColor="Gray" />
                            </StackLayout>

                          <!-- Tap handler attached to the Grid -->
                          <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnItemTapped" NumberOfTapsRequired="1" CommandParameter="{Binding .}" />
                          </Grid.GestureRecognizers>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Entry 
                Placeholder="'Która strona?' :)"
                Text="{Binding PageFilter}"
                Keyboard="Numeric"
                Completed="OnPageFilterCompleted" 
                Grid.Row="3"
                />

            <!-- Overlay loading indicator bound to VM.IsBusy -->
            <AbsoluteLayout Grid.Row="0" Grid.RowSpan="4" IsVisible="{Binding IsBusy}" Opacity="0.3">
                <BoxView AbsoluteLayout.LayoutBounds="0,0,1,1"
                         AbsoluteLayout.LayoutFlags="All"
                         Color="{AppThemeBinding Light=#FFF, Dark=#000}"
                         IsVisible="{Binding IsBusy}" />

                <ActivityIndicator AbsoluteLayout.LayoutBounds="0.5,0.5,48,48"
                                   AbsoluteLayout.LayoutFlags="PositionProportional"
                                   IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center" />
            </AbsoluteLayout>
        </Grid>
    </ContentPage.Content>
</ContentPage>